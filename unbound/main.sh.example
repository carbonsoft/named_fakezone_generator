#!/bin/bash

set -eu

LOCKFILE=/tmp/fakezone_generator.lock
exec 3>$LOCKFILE

if ! flock -w 60 -x 3; then
	echo "Не удалось захватить lock fakezone_generator"
	exit 1
fi
REDUCTOR_IP=10.0.0.1

# чтобы scp не спрашивал пароль нужно создать ssh-ключи и закинуть их с помощью ssh-copy-id на carbon reductor

carbon_reductor_7() {
	scp root@$REDUCTOR_IP:/usr/local/Reductor/userinfo/config /tmp/reductor.config
	scp root@$REDUCTOR_IP:/usr/local/Reductor/lists/https.resolv /tmp/reductor.https.resolv
}

carbon_reductor_8() {
	scp root@$REDUCTOR_IP:/app/reductor/cfg/config /tmp/reductor.config
	scp root@$REDUCTOR_IP:/app/reductor/usr/local/Reductor/lists/https.resolv /tmp/reductor.https.resolv
}

# замените на "carbon_reductor_7", если используете Carbon Reductor 7.
carbon_reductor_8

. /tmp/reductor.config

/opt/named_fakezone_generator/unbound/generate_unbound_configs.sh /tmp/reductor.https.resolv "${filter['dns_ip']}"
flock -u 3
